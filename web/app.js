const readFileText=(file)=>new Promise((resolve,reject)=>{const r=new FileReader();r.onload=()=>resolve(r.result);r.onerror=e=>reject(e);r.readAsText(file,'utf-8')});
const tokenize=(s)=>{if(!s)return[];const t=s.toLowerCase();const m=t.match(/[\u4e00-\u9fa5]+|[a-z0-9_+.#]+/g);return m?m:[]};
const jaccard=(a,b)=>{const sa=new Set(a),sb=new Set(b);if(sa.size===0||sb.size===0)return 0;let inter=0;for(const v of sa)if(sb.has(v))inter++;return inter/(sa.size+sb.size-inter)};
const cosineCount=(a,b)=>{if(a.length===0||b.length===0)return 0;const fa={},fb={};for(const x of a)fa[x]=(fa[x]||0)+1;for(const y of b)fb[y]=(fb[y]||0)+1;const vocab=new Set([...Object.keys(fa),...Object.keys(fb)]);let dot=0,na=0,nb=0;for(const v of vocab){const va=fa[v]||0,vb=fb[v]||0;dot+=va*vb;na+=va*va;nb+=vb*vb}return na&&nb?dot/(Math.sqrt(na)*Math.sqrt(nb)):0};
const parseSalary=(s)=>{if(!s)return{min:null,max:null,months:12,negotiable:false};const negotiable=(s.indexOf('é¢è®®')>=0);let months=12;const mm=s.match(/(?:Â·|x|Ã—)\s*(\d+)\s*è–ª/);if(mm)months=parseInt(mm[1]);const m=s.match(/(\d+)[-~](\d+)k/i);let min=null,max=null;if(m){min=parseInt(m[1])*1000*months;max=parseInt(m[2])*1000*months}return{min,max,months,negotiable}};
const eduOrder={'ä¸é™':0,'å¤§ä¸“':1,'æœ¬ç§‘':2,'ç¡•å£«':3,'åšå£«':4,'å…¶ä»–':1};
const textTokensResume=(resume)=>{const parts=[];try{(resume.work_preferences?.position_type_name||[]).forEach(p=>parts.push(String(p)))}catch(e){}if(resume.full_resume_text)parts.push(resume.full_resume_text);return tokenize(parts.join(' '))};
const textTokensJob=(job)=>{const f=[job['å²—ä½åç§°']||'',job['å²—ä½è¦æ±‚']||'',job['å²—ä½èŒè´£']||'',job['äºŒçº§åˆ†ç±»']||'',job['ä¸‰çº§åˆ†ç±»']||''];return tokenize(f.join(' '))};
const titleTokens=(title)=>tokenize(String(title||''));
const checkLocation=(job,city)=>{const addr=String(job['å²—ä½åœ°å€']||'');const jobCity=String(job['åŸå¸‚']||'');if(city&&addr.indexOf(city)>=0)return true;if(city&&jobCity&&jobCity.indexOf(city)>=0)return true;return false};
const scoreJob=(resume,job,w)=>{let score=0;const reasons=[];const jobPos=String(job['ä¸‰çº§åˆ†ç±»']||'');const intent=(resume.work_preferences?.position_type_name||[]).map(x=>String(x).toLowerCase());if(jobPos&&intent.some(p=>p.trim().toLowerCase()===jobPos.trim().toLowerCase())){score+=w.pos;reasons.push(`èŒä½ç±»å‹åŒ¹é…: ${jobPos}`)}if(!(resume.personal_info?.willingness_to_relocate)){if(checkLocation(job,resume.personal_info?.current_city)){score+=w.loc;reasons.push(`åœ°ç‚¹åŒ¹é…: ${resume.personal_info?.current_city}`)}else{reasons.push(`åœ°ç‚¹ä¸åŒ¹é…`)}}else{score+=0.2;reasons.push(`å€™é€‰äººå¯å¼‚åœ°å·¥ä½œ`)}const salStr=String(job['å²—ä½è–ªèµ„']||'');const sal=parseSalary(salStr);if(!salStr||salStr==='é¢è®®'){score+=w.sal*0.4;reasons.push(`è–ªèµ„é¢è®®`)}else if(sal.max&&sal.max>= (resume.work_preferences?.salary_expectation?.min_annual_package||0)){score+=w.sal;reasons.push(`è–ªèµ„æ»¡è¶³: æœ€é«˜${Math.floor(sal.max/10000)}ä¸‡ â‰¥ æœŸæœ›${Math.floor((resume.work_preferences?.salary_expectation?.min_annual_package||0)/10000)}ä¸‡`)}else if(sal.max){reasons.push(`è–ªèµ„ä¸è¶³: æœ€é«˜${Math.floor(sal.max/10000)}ä¸‡ < æœŸæœ›${Math.floor((resume.work_preferences?.salary_expectation?.min_annual_package||0)/10000)}ä¸‡`)}else{reasons.push(`è–ªèµ„ä¿¡æ¯ä¸æ˜ç¡®`)}const req=String(job['å²—ä½è¦æ±‚']||'');const em=req.match(/(\d+)[å¹´\-~]+/);if(!req){score+=w.exp*0.5;reasons.push(`æ— æ˜ç¡®å¹´é™è¦æ±‚`)}else if(em){const required=parseInt(em[1]);const cand=parseFloat(resume.professional_summary?.total_experience_years||0);if(cand>=required){score+=w.exp;reasons.push(`å¹´é™æ»¡è¶³: ${cand}å¹´ â‰¥ ${required}å¹´`)}else{reasons.push(`å¹´é™ä¸è¶³: ${cand}å¹´ < ${required}å¹´`)}}else{score+=w.exp*0.3;reasons.push(`å¹´é™è¦æ±‚ä¸æ˜ç¡®`)}const eduKeys=['åšå£«','ç¡•å£«','æœ¬ç§‘','å¤§ä¸“'];let requiredEdu=null;for(const e of eduKeys){if(req.indexOf(e)>=0){requiredEdu=e;break}}if(!requiredEdu){score+=w.edu*0.5;reasons.push(`æ— æ˜ç¡®å­¦å†è¦æ±‚`)}else{const candEdu=String(resume.professional_summary?.education_level||'');const cr=eduOrder[candEdu]||0;const rr=eduOrder[requiredEdu]||0;if(cr>=rr){score+=w.edu;reasons.push(`å­¦å†æ»¡è¶³: ${candEdu} â‰¥ ${requiredEdu}`)}else{reasons.push(`å­¦å†ä¸è¶³: ${candEdu} < ${requiredEdu}`)}}const schoolReq=req.indexOf('985')>=0?2:(req.indexOf('211')>=0?1:0);const candSchool=resume.professional_summary?.school_level||0;if(schoolReq===2){if(candSchool===2){score+=w.sch;reasons.push(`é™¢æ ¡å±‚æ¬¡: 985`)}else{reasons.push(`é™¢æ ¡å±‚æ¬¡: éœ€è¦985`)}}else if(schoolReq===1){if(candSchool>=1){score+=w.sch;reasons.push(`é™¢æ ¡å±‚æ¬¡: ${candSchool===2?'985':'211'}`)}else{reasons.push(`é™¢æ ¡å±‚æ¬¡: éœ€è¦211`)}}const rt=textTokensResume(resume);const jt=textTokensJob(job);const j=jaccard(rt,jt);const c=cosineCount(rt,jt);const s=0.5*j+0.5*c;if(s>0){score+=w.txt*s;reasons.push(`æ–‡æœ¬ç›¸ä¼¼åº¦: ${s.toFixed(3)} (Jaccard ${j.toFixed(3)}, Cosine ${c.toFixed(3)})`)}const titleMatch=(()=>{const ts=new Set(titleTokens(job['å²—ä½åç§°']));const intentTokens=new Set([...(resume.work_preferences?.position_type_name||[]).flatMap(x=>titleTokens(x))]);let inter=0;for(const t of ts)if(intentTokens.has(t))inter++;return inter>0?inter:0})();if(titleMatch>0){score+=w.tit;reasons.push(`æ ‡é¢˜æ„å‘åŒ¹é…: å…³é”®è¯é‡åˆ${titleMatch}`)}return{score:parseFloat(score.toFixed(3)),reasons};};
const parseJSONL=(text)=>{const lines=text.split(/\r?\n/).filter(x=>x.trim().length>0);return lines.map(l=>JSON.parse(l)).map(o=>({ 'å²—ä½åç§°':o.job_identity?.original_job_title||'', 'ä¼ä¸š':o.job_identity?.company_name||'', 'å²—ä½è–ªèµ„':'', 'å²—ä½è¦æ±‚':o.original_text?.raw_requirements||'', 'å²—ä½èŒè´£':o.original_text?.raw_responsibilities||'', 'å²—ä½åœ°å€':o.location?.address||'', 'äºŒçº§åˆ†ç±»':o.job_identity?.secondary_category||'', 'ä¸‰çº§åˆ†ç±»':o.job_identity?.position_type_name||'', 'åŸå¸‚':o.location?.city||'' }));};
const parseCSV=async(file)=>{const text=await readFileText(file);const rows=text.split(/\r?\n/);const header=rows[0].split(',');const data=[];for(let i=1;i<rows.length;i++){if(!rows[i].trim())continue;const cols=rows[i].split(',');const obj={};for(let j=0;j<header.length;j++){obj[header[j]]=cols[j]||''}data.push(obj)}return data};
const renderResults=(list)=>{const root=document.getElementById('results');root.innerHTML='';list.forEach(m=>{const div=document.createElement('div');div.className='card';const h=document.createElement('h3');h.textContent=(m.job_title||'')+' Â· '+(m.company_name||'');div.appendChild(h);const meta=document.createElement('div');meta.className='meta';const tags=[m.position_type_name,m.city,m.salary].filter(Boolean);tags.forEach(t=>{const span=document.createElement('span');span.className='tag';span.textContent=t;meta.appendChild(span)});div.appendChild(meta);const sc=document.createElement('div');sc.className='score';sc.textContent='åŒ¹é…åº¦';div.appendChild(sc);const progress=document.createElement('div');progress.className='progress';const bar=document.createElement('div');bar.className='progress-bar';const pct=Math.max(0,Math.min(100,Math.round(m.score/5*100)));bar.style.width=pct+'%';progress.appendChild(bar);div.appendChild(progress);const rs=document.createElement('div');rs.className='reasons';m.reasons.slice(0,6).forEach(r=>{const p=document.createElement('div');p.className='reason';p.textContent='â€¢ '+r;rs.appendChild(p)});div.appendChild(rs);root.appendChild(div)});};
function renderLLM(text){const el=document.getElementById('llmRec');if(!el)return;el.innerHTML='';const pre=document.createElement('pre');pre.className='llm-pre';pre.textContent=String(text||'');el.appendChild(pre);} 
const state={resume:null,jobs:[],lastResults:[]};
async function loadJobs(){try{const r=await fetch('/api/jobs');if(!r.ok){throw new Error('çŠ¶æ€ç  '+r.status)}const data=await r.json();state.jobs=data.jobs||[]}catch(e){addChat('assistant','æ¥å£ä¸å¯ç”¨ï¼š/api/jobs - '+e.message)}}
function getResume(){const positions=(document.getElementById('positions').value||'').split(',').map(x=>x.trim()).filter(x=>x);return state.resume||{ personal_info:{ current_city:document.getElementById('currentCity').value||'', willingness_to_relocate:(document.getElementById('relocate').value==='true') }, work_preferences:{ position_type_name:positions, salary_expectation:{ min_annual_package: parseInt(document.getElementById('minAnnual').value||'0') } }, professional_summary:{ total_experience_years:0, education_level:'æœ¬ç§‘', school_level:0 }, full_resume_text:'' }}
function getWeights(){return{ pos:parseFloat(document.getElementById('wPos').value), loc:parseFloat(document.getElementById('wLoc').value), sal:parseFloat(document.getElementById('wSal').value), exp:parseFloat(document.getElementById('wExp').value), edu:parseFloat(document.getElementById('wEdu').value), sch:parseFloat(document.getElementById('wSch').value), txt:parseFloat(document.getElementById('wTxt').value), tit:parseFloat(document.getElementById('wTit').value) }}
document.getElementById('runBtn').addEventListener('click',async(event)=>{const cleanup=window.triggerMatchButtonEffects?window.triggerMatchButtonEffects(event):null;const limit=parseInt(document.getElementById('limit').value||'10');const minScore=parseFloat(document.getElementById('minScore').value||'0.5');const useLLM=document.getElementById('useLLM')?.checked;const useXGB=document.getElementById('useXGB')?.checked;const resume=getResume();console.log('å¼€å§‹åŒ¹é…ï¼Œç®€å†ä¿¡æ¯:',JSON.stringify(resume,null,2));try{const res=await fetch('/api/recommend',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({use_llm: !!useLLM, use_xgb: !!useXGB, min_score: minScore, limit, resume})});if(!res.ok){const t=await res.text();addChat('assistant','æ¥å£é”™è¯¯ï¼š'+res.status+' '+t.slice(0,120));if(cleanup)cleanup();return}const data=await res.json();if(data.jobs){renderResultsEx(data.jobs);if(data.jobs.length===0){addChat('assistant','æœªæ‰¾åˆ°åŒ¹é…çš„å²—ä½ï¼Œå»ºè®®ï¼š1) æ£€æŸ¥ç›®æ ‡èŒä½æ˜¯å¦å‡†ç¡® 2) é™ä½æœ€ä½åŒ¹é…åº¦è¦æ±‚ 3) é€‰æ‹©"è€ƒè™‘å¼‚åœ°æœºä¼š"æ‰©å¤§èŒƒå›´');}}const reply=(data.assistant_reply)||'æ¨èç»“æœå·²ç”Ÿæˆ';messages.push({role:'assistant',content:reply});addChat('assistant',reply);if(cleanup)cleanup();}catch(e){addChat('assistant','ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡æœªå¯åŠ¨');if(cleanup)cleanup();}});

// AI chat resume & weights
const chatList=document.getElementById('chatList');
const messages=[];
function mdToHtml(text){const lines=String(text||'').split(/\r?\n/);let html='';let inList=false;let inTable=false;let tableRows=[];for(let i=0;i<lines.length;i++){const ln=lines[i];if(/\|/.test(ln)){inTable=true;tableRows.push(ln);continue}else if(inTable){html+=buildTable(tableRows);inTable=false;tableRows=[]}
 if(/^###\s+/.test(ln)){html+=`<h3>${escapeHtml(ln.replace(/^###\s+/,''))}</h3>`;continue}
 if(/^##\s+/.test(ln)){html+=`<h2>${escapeHtml(ln.replace(/^##\s+/,''))}</h2>`;continue}
 if(/^#\s+/.test(ln)){html+=`<h1>${escapeHtml(ln.replace(/^#\s+/,''))}</h1>`;continue}
 if(/^[-*]\s+/.test(ln)){if(!inList){html+='<ul>';inList=true}html+=`<li>${inlineFormat(ln.replace(/^[-*]\s+/,''))}</li>`;continue}else if(inList){html+='</ul>';inList=false}
 if(ln.trim().length===0){html+='<br/>';continue}
 html+=`<div>${inlineFormat(ln)}</div>`}
 if(inList)html+='</ul>';if(inTable)html+=buildTable(tableRows);return html}
function buildTable(rows){let out='<table><tbody>';for(let i=0;i<rows.length;i++){const cols=rows[i].split('|').map(s=>s.trim()).filter(s=>s.length>0);if(cols.length===0)continue;if(i===1 && /^:?-{3,}:?$/.test(cols[0]))continue;const tag=(i===0)?'th':'td';out+='<tr>';for(const c of cols){out+=`<${tag}>${escapeHtml(c)}</${tag}>`}out+='</tr>'}out+='</tbody></table>';return out}
function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function inlineFormat(s){let x=escapeHtml(s);x=x.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');x=x.replace(/`([^`]+)`/g,'<code>$1</code>');return x}
function addChat(role,content){const item=document.createElement('div');item.className='chat-item';const r=document.createElement('span');r.className='role';r.textContent=role==='user'?'æˆ‘':'åŠ©æ‰‹';item.appendChild(r);if(role==='assistant'){const card=document.createElement('div');card.className='chat-card';const cc=document.createElement('div');cc.className='chat-content';cc.innerHTML=mdToHtml(content);card.appendChild(cc);item.appendChild(card)}else{const c=document.createElement('span');c.textContent=content;item.appendChild(c)}chatList.appendChild(item);chatList.scrollTop=chatList.scrollHeight}
// load resume from local txt
const chatFile=document.getElementById('chatFile');
if(chatFile){chatFile.addEventListener('change',async(e)=>{const f=e.target.files[0];const label=document.querySelector('.file-upload-text');if(!f){if(label)label.textContent='.txtæ ¼å¼';return}if(label)label.textContent=f.name;try{const t=await readFileText(f);if(!t||t.trim().length===0){alert('æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œè¯·é€‰æ‹©åŒ…å«æ–‡æœ¬çš„æ–‡ä»¶');if(label)label.textContent='.txtæ ¼å¼';return}document.getElementById('chatText').value=t;console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…±'+t.length+'ä¸ªå­—ç¬¦')}catch(err){console.error('æ–‡ä»¶è¯»å–å¤±è´¥:',err);alert('æ–‡ä»¶è¯»å–å¤±è´¥: '+err.message);if(label)label.textContent='.txtæ ¼å¼'}finally{chatFile.value=''}})}
document.getElementById('chatSend').addEventListener('click',async()=>{const text=document.getElementById('chatText').value.trim();if(!text)return;document.getElementById('chatText').value='';messages.push({role:'user',content:text});addChat('user',text);try{const useLLM=document.getElementById('useLLM')?.checked;const autoSync=document.getElementById('autoSync')?.checked;console.log('[å‰ç«¯DEBUG] useLLMå¤é€‰æ¡†çŠ¶æ€:', useLLM);console.log('[å‰ç«¯DEBUG] autoSyncå¤é€‰æ¡†çŠ¶æ€:', autoSync);console.log('[å‰ç«¯DEBUG] å‘é€payload:', {messages, use_llm: !!useLLM, extract_resume: !!autoSync});const res=await fetch('/api/chat_resume',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages, use_llm: !!useLLM, extract_resume: !!autoSync})});if(!res.ok){const t=await res.text();addChat('assistant','æ¥å£é”™è¯¯ï¼š'+res.status+' '+t.slice(0,120));return}const data=await res.json();const reply=(data.assistant_reply)||'åŠ©æ‰‹æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•';messages.push({role:'assistant',content:reply});addChat('assistant',reply);if(data.resume_profile){state.resume=data.resume_profile;const auto=document.getElementById('autoSync')?.checked;if(auto){document.getElementById('currentCity').value=data.resume_profile.personal_info?.current_city||'';document.getElementById('relocate').value=(data.resume_profile.personal_info?.willingness_to_relocate?'true':'false');document.getElementById('minAnnual').value=data.resume_profile.work_preferences?.salary_expectation?.min_annual_package||0;document.getElementById('positions').value=(data.resume_profile.work_preferences?.position_type_name||[]).join(', ');}}if(data.weight_suggestion){const w=data.weight_suggestion;document.getElementById('wPos').value=w.POSITION_TYPE_WEIGHT;document.getElementById('wLoc').value=w.LOCATION_WEIGHT;document.getElementById('wSal').value=w.SALARY_WEIGHT;document.getElementById('wExp').value=w.EXPERIENCE_WEIGHT;document.getElementById('wEdu').value=w.EDUCATION_WEIGHT;document.getElementById('wSch').value=w.SCHOOL_LEVEL_WEIGHT;document.getElementById('wTxt').value=w.TEXT_SIMILARITY_WEIGHT;document.getElementById('wTit').value=w.TITLE_INTENT_WEIGHT;}}catch(e){addChat('assistant','ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡æœªå¯åŠ¨');}});

document.getElementById('aiSuggest').addEventListener('click',async()=>{messages.push({role:'user',content:'è¯·æ ¹æ®æˆ‘çš„ç®€å†å’Œåå¥½ï¼Œå»ºè®®åŒ¹é…æƒé‡å¹¶è¯´æ˜ç†ç”±'});addChat('user','è¯·æ ¹æ®æˆ‘çš„ç®€å†å’Œåå¥½ï¼Œå»ºè®®åŒ¹é…æƒé‡å¹¶è¯´æ˜ç†ç”±');try{const useLLM=document.getElementById('useLLM')?.checked;const autoSync=document.getElementById('autoSync')?.checked;const res=await fetch('/api/chat_resume',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages, use_llm: !!useLLM, extract_resume: !!autoSync})});if(!res.ok){const t=await res.text();addChat('assistant','æ¥å£é”™è¯¯ï¼š'+res.status+' '+t.slice(0,120));return}const data=await res.json();const reply=data.assistant_reply||'å·²ç»™å‡ºæƒé‡å»ºè®®';messages.push({role:'assistant',content:reply});addChat('assistant',reply);if(data.weight_suggestion){const w=data.weight_suggestion;document.getElementById('wPos').value=w.POSITION_TYPE_WEIGHT;document.getElementById('wLoc').value=w.LOCATION_WEIGHT;document.getElementById('wSal').value=w.SALARY_WEIGHT;document.getElementById('wExp').value=w.EXPERIENCE_WEIGHT;document.getElementById('wEdu').value=w.EDUCATION_WEIGHT;document.getElementById('wSch').value=w.SCHOOL_LEVEL_WEIGHT;document.getElementById('wTxt').value=w.TEXT_SIMILARITY_WEIGHT;document.getElementById('wTit').value=w.TITLE_INTENT_WEIGHT;}}catch(e){addChat('assistant','ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡æœªå¯åŠ¨')}});

// ç®€å†å®Œå–„åŠŸèƒ½ - è¾…åŠ©agent
let isInfoCollectionComplete = false;
let infoCollectionMessages = [];

document.getElementById('enhanceResume').addEventListener('click',async()=>{const resumeText=document.getElementById('chatText').value.trim();if(!resumeText){alert('è¯·åœ¨è¾“å…¥æ¡†ä¸­ç²˜è´´æ‚¨çš„ç®€å†å†…å®¹');return}try{addChat('user','[å¼€å§‹ç®€å†ä¿¡æ¯æ”¶é›†]');const res=await fetch('/api/resume_enhance',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({resume_text:resumeText,current_profile:getResume(),messages})});if(!res.ok){const t=await res.text();addChat('assistant','ç®€å†å®Œå–„æ¥å£é”™è¯¯ï¼š'+res.status+' '+t.slice(0,120));return}const data=await res.json();if(data.enhanced_profile){state.resume=data.enhanced_profile;const pi=data.enhanced_profile.personal_info||{};const wp=(data.enhanced_profile.work_preferences)||{};if(pi.current_city!==undefined)document.getElementById('currentCity').value=pi.current_city||'';if(pi.willingness_to_relocate!==undefined)document.getElementById('relocate').value=pi.willingness_to_relocate?'true':'false';const pos=(wp.position_type_name)||[];if(pos.length>0)document.getElementById('positions').value=pos.join(', ');const sal=(wp.salary_expectation||{}).min_annual_package;if(sal!==undefined&&sal!==null)document.getElementById('minAnnual').value=sal}if(data.assistant_reply){addChat('assistant',data.assistant_reply);infoCollectionMessages.push({role:'assistant',content:data.assistant_reply})}isInfoCollectionComplete = !!data.is_complete;if(data.missing_fields&&data.missing_fields.length>0){addChat('assistant','ä»éœ€è¡¥å……ï¼š'+data.missing_fields.join('ã€'))}}catch(e){addChat('assistant','ç®€å†å®Œå–„æœåŠ¡æš‚ä¸å¯ç”¨');}});

// ä¸»agent - åˆ¤æ–­ä¿¡æ¯æ˜¯å¦å®Œæ•´å¹¶æ‰§è¡Œæ¨è
document.getElementById('runBtn').addEventListener('click',async(event)=>{const cleanup=window.triggerMatchButtonEffects?window.triggerMatchButtonEffects(event):null;if(!isInfoCollectionComplete){const resumeText=document.getElementById('chatText').value.trim();const resEnh=await fetch('/api/resume_enhance',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({resume_text:resumeText||'ä¸ºä¾¿äºæ¨èï¼Œè¯·å®Œå–„æˆ‘çš„ç®€å†ä¿¡æ¯',current_profile:getResume(),messages})});if(resEnh.ok){const d=await resEnh.json();if(d.assistant_reply){addChat('assistant',d.assistant_reply)}if(d.enhanced_profile){state.resume=d.enhanced_profile}isInfoCollectionComplete=!!d.is_complete;if(!isInfoCollectionComplete){if(cleanup)cleanup();return}}}
const limit=parseInt(document.getElementById('limit').value||'10');const minScore=parseFloat(document.getElementById('minScore').value||'0.5');const useLLM=document.getElementById('useLLM')?.checked;const useXGB=document.getElementById('useXGB')?.checked;const resume=getResume();console.log('å¼€å§‹åŒ¹é…ï¼Œç®€å†ä¿¡æ¯:',JSON.stringify(resume,null,2));try{const res=await fetch('/api/recommend',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({use_llm: !!useLLM, use_xgb: !!useXGB, min_score: minScore, limit, resume})});if(!res.ok){const t=await res.text();addChat('assistant','æ¥å£é”™è¯¯ï¼š'+res.status+' '+t.slice(0,120));if(cleanup)cleanup();return}const data=await res.json();if(data.jobs){renderResultsEx(data.jobs);if(data.jobs.length===0){addChat('assistant','æœªæ‰¾åˆ°åŒ¹é…çš„å²—ä½ï¼Œå»ºè®®ï¼š1) æ£€æŸ¥ç›®æ ‡èŒä½æ˜¯å¦å‡†ç¡® 2) é™ä½æœ€ä½åŒ¹é…åº¦è¦æ±‚ 3) é€‰æ‹©"è€ƒè™‘å¼‚åœ°æœºä¼š"æ‰©å¤§èŒƒå›´');}}const reply=(data.assistant_reply)||'æ¨èç»“æœå·²ç”Ÿæˆ';messages.push({role:'assistant',content:reply});addChat('assistant',reply);if(cleanup)cleanup();}catch(e){addChat('assistant','ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡æœªå¯åŠ¨');if(cleanup)cleanup();}});
// å¢å¼ºçš„ç»“æœæ¸²æŸ“ä¸äº¤äº’
function renderResultsEx(list){state.lastResults=list||[];const root=document.getElementById('results');root.innerHTML='';state.lastResults.forEach((m,idx)=>{const div=document.createElement('div');div.className='card';const h=document.createElement('h3');h.textContent=(m.job_title||'')+' Â· '+(m.company_name||'');div.appendChild(h);const meta=document.createElement('div');meta.className='meta';const tags=[m.position_type_name,m.city,m.salary].filter(Boolean);tags.forEach(t=>{const span=document.createElement('span');span.className='tag';span.textContent=t;meta.appendChild(span)});div.appendChild(meta);const sc=document.createElement('div');sc.className='score';sc.textContent='åŒ¹é…åº¦';div.appendChild(sc);const progress=document.createElement('div');progress.className='progress';const bar=document.createElement('div');bar.className='progress-bar';const pct=Math.max(0,Math.min(100,Math.round((m.score||0)/5*100)));bar.style.width=pct+'%';progress.appendChild(bar);div.appendChild(progress);const rs=document.createElement('div');rs.className='reasons';(m.reasons||[]).slice(0,6).forEach(r=>{const p=document.createElement('div');p.className='reason';p.textContent='â€¢ '+r;rs.appendChild(p)});div.appendChild(rs);const actions=document.createElement('div');actions.className='card-actions';const btnMore=document.createElement('button');btnMore.className='primary-btn';btnMore.textContent='è¯¦ç»†ç†ç”±';btnMore.onclick=()=>{rs.innerHTML='';(m.reasons||[]).forEach(r=>{const p=document.createElement('div');p.className='reason';p.textContent='â€¢ '+r;rs.appendChild(p)});};const btnRemove=document.createElement('button');btnRemove.className='primary-btn';btnRemove.style.background='#fee';btnRemove.style.color='#333';btnRemove.textContent='ç§»é™¤';btnRemove.onclick=()=>{state.lastResults.splice(idx,1);renderResultsEx(state.lastResults)};const btnLike=document.createElement('button');btnLike.className='primary-btn';btnLike.style.background='linear-gradient(90deg,#d4f9d4,#b5f7b5)';btnLike.textContent='æ„Ÿå…´è¶£';btnLike.onclick=()=>sendFeedback('like',m);const btnSkip=document.createElement('button');btnSkip.className='primary-btn';btnSkip.style.background='#eef';btnSkip.style.color='#333';btnSkip.textContent='ä¸ç›¸å…³';btnSkip.onclick=()=>sendFeedback('skip',m);actions.appendChild(btnMore);actions.appendChild(btnRemove);actions.appendChild(btnLike);actions.appendChild(btnSkip);div.appendChild(actions);root.appendChild(div)});} 
function sendFeedback(action,m){try{fetch('/api/feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action, job:m.job_raw||m, resume:getResume()})})}catch(e){} }
document.getElementById('rescoreBtn')?.addEventListener('click',()=>{const w=getWeights();const resume=getResume();const list=state.lastResults.map(x=>{const raw=x.job_raw||null;if(!raw)return x;const s=scoreJob(resume,raw,w);return {...x, score:s, reasons:(x.reasons||[])} });list.sort((a,b)=> ((b.score?.score)||b.score||0) - ((a.score?.score)||a.score||0));const mapped=list.map(u=>({...u, score:(u.score?.score)||u.score}));renderResultsEx(mapped)});

async function fetchEvents(){try{const r=await fetch('/api/recommend_events',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'list'})});if(!r.ok)return;const data=await r.json();renderEvents(data.items||[])}catch(e){}}
function renderEvents(items){const root=document.getElementById('eventsList');if(!root)return;root.innerHTML='';items.forEach(it=>{const div=document.createElement('div');div.className='card';const h=document.createElement('h3');h.textContent=(it.type||'äº‹ä»¶')+' Â· '+(it.action||'');div.appendChild(h);const meta=document.createElement('div');meta.className='meta';const tags=[];if(it.ts)tags.push(new Date(it.ts).toLocaleString());if(it.job&&it.job['å²—ä½åç§°'])tags.push(it.job['å²—ä½åç§°']);if(it.job&&it.job['ä¼ä¸š'])tags.push(it.job['ä¼ä¸š']);tags.filter(Boolean).forEach(t=>{const span=document.createElement('span');span.className='tag';span.textContent=t;meta.appendChild(span)});div.appendChild(meta);const rs=document.createElement('div');rs.className='reasons';const p=document.createElement('div');p.className='reason';p.textContent=(it.note||'');rs.appendChild(p);div.appendChild(rs);const actions=document.createElement('div');actions.className='card-actions';const btnNote=document.createElement('button');btnNote.className='primary-btn';btnNote.textContent='æ ‡æ³¨å¤‡æ³¨';btnNote.onclick=async()=>{const nv=prompt('è¯·è¾“å…¥å¤‡æ³¨',it.note||'');if(nv===null)return;await fetch('/api/recommend_events',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'update',event:{id:it.id,note:nv}})});fetchEvents()};const btnDel=document.createElement('button');btnDel.className='primary-btn';btnDel.style.background='#fee';btnDel.style.color='#333';btnDel.textContent='åˆ é™¤';btnDel.onclick=async()=>{console.log('[åˆ é™¤] ç‚¹å‡»åˆ é™¤ï¼ŒID:', it.id);if(!it.id){alert('é”™è¯¯ï¼šäº‹ä»¶æ²¡æœ‰IDï¼Œæ— æ³•åˆ é™¤');return}if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')){return}try{const r=await fetch('/api/recommend_events',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'delete',id:it.id})});const data=await r.json();console.log('[åˆ é™¤] æœåŠ¡å™¨å“åº”:', data);if(data.ok||data.deleted){alert('åˆ é™¤æˆåŠŸï¼');fetchEvents()}else{alert('åˆ é™¤å¤±è´¥ï¼š'+(data.error||'æœªçŸ¥é”™è¯¯'))}}catch(e){console.error('[åˆ é™¤] é”™è¯¯:', e);alert('åˆ é™¤è¯·æ±‚å¤±è´¥ï¼š'+e.message)}};actions.appendChild(btnNote);actions.appendChild(btnDel);div.appendChild(actions);root.appendChild(div)})}
document.getElementById('eventsImport')?.addEventListener('click',async()=>{try{const r=await fetch('/api/recommend_events',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'import_feedback'})});if(!r.ok)return;await r.json();fetchEvents()}catch(e){}});
document.getElementById('eventsRefresh')?.addEventListener('click',fetchEvents);
// fetchEvents();  // ä¸è‡ªåŠ¨åŠ è½½ï¼Œéœ€è¦æ—¶ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®

document.getElementById('exportXGB')?.addEventListener('click',async()=>{try{const r=await fetch('/api/xgb_ops',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'export'})});const d=await r.json();if(d.success){updateDataStats(d.stats);addChat('assistant','âœ… å·²å¯¼å‡ºè®­ç»ƒæ•°æ®ï¼š'+(d.path||'')+'ï¼Œæ€»æ ·æœ¬æ•° '+(d.samples||0))}else{addChat('assistant','âŒ å¯¼å‡ºè®­ç»ƒæ•°æ®å¤±è´¥ï¼š'+(d.error||''))}}catch(e){addChat('assistant','âŒ å¯¼å‡ºè®­ç»ƒæ•°æ®å¤±è´¥')}});
document.getElementById('trainXGB')?.addEventListener('click',async()=>{try{addChat('assistant','â³ å¼€å§‹è®­ç»ƒXGBoostæ¨¡å‹ï¼Œè¯·ç¨å€™...');const r=await fetch('/api/xgb_ops',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'train'})});const d=await r.json();if(d.success){const m=d.metrics||{};updateTrainingMetrics(m);let msg='âœ… XGBoostæ¨¡å‹è®­ç»ƒå®Œæˆï¼\n';msg+='\nğŸ“ æ¨¡å‹è·¯å¾„ï¼š'+(d.model_path||'');msg+='\nğŸ“Š æ€»æ ·æœ¬æ•°ï¼š'+(d.samples||0);if(m.data_stats){const ds=m.data_stats;msg+='\n   - æ­£æ ·æœ¬ï¼š'+ds.positive_samples+' ('+Math.round(ds.positive_ratio*100)+'%)';msg+='\n   - è´Ÿæ ·æœ¬ï¼š'+ds.negative_samples+' ('+Math.round(ds.negative_ratio*100)+'%)';}if(m.val){msg+='\nğŸ¯ éªŒè¯é›†æŒ‡æ ‡ï¼š';if(m.val.auc)msg+='\n   - AUC: '+m.val.auc.toFixed(4);if(m.val.accuracy)msg+='\n   - å‡†ç¡®ç‡: '+m.val.accuracy.toFixed(4);if(m.val.precision)msg+='\n   - ç²¾ç¡®ç‡: '+m.val.precision.toFixed(4);if(m.val.recall)msg+='\n   - å¬å›ç‡: '+m.val.recall.toFixed(4);if(m.val.f1)msg+='\n   - F1åˆ†æ•°: '+m.val.f1.toFixed(4);}addChat('assistant',msg)}else{addChat('assistant','âŒ XGBoostæ¨¡å‹è®­ç»ƒå¤±è´¥ï¼š'+(d.error||''))}}catch(e){addChat('assistant','âŒ XGBoostæ¨¡å‹è®­ç»ƒå¤±è´¥')}});
function updateDataStats(stats){if(!stats)return;const div=document.getElementById('dataStats');if(!div)return;div.style.display='block';document.getElementById('totalSamples').textContent=stats.total_samples||0;document.getElementById('positiveSamples').textContent=stats.positive_samples||0;document.getElementById('negativeSamples').textContent=stats.negative_samples||0;}
function updateTrainingMetrics(metrics){if(!metrics||!metrics.val)return;const div=document.getElementById('trainingMetrics');if(!div)return;div.style.display='block';const v=metrics.val;document.getElementById('metricAUC').textContent=(v.auc||0).toFixed(4);document.getElementById('metricAccuracy').textContent=(v.accuracy||0).toFixed(4);document.getElementById('metricPrecision').textContent=(v.precision||0).toFixed(4);document.getElementById('metricRecall').textContent=(v.recall||0).toFixed(4);document.getElementById('metricF1').textContent=(v.f1||0).toFixed(4);}
document.getElementById('clearChat')?.addEventListener('click',()=>{messages.length=0;document.getElementById('chatList').innerHTML=''});
document.getElementById('deleteLast')?.addEventListener('click',()=>{if(messages.length>0){messages.splice(messages.length-1,1);renderChat()}});
function renderChat(){const list=document.getElementById('chatList');list.innerHTML='';for(let i=0;i<messages.length;i++){const m=messages[i];const item=document.createElement('div');item.className='chat-item';const r=document.createElement('span');r.className='role';r.textContent=m.role==='user'?'æˆ‘':'åŠ©æ‰‹';item.appendChild(r);if(m.role==='assistant'){const card=document.createElement('div');card.className='chat-card';const cc=document.createElement('div');cc.className='chat-content';cc.innerHTML=mdToHtml(m.content);card.appendChild(cc);item.appendChild(card)}else{const c=document.createElement('span');c.textContent=m.content;item.appendChild(c)}const del=document.createElement('button');del.className='primary-btn';del.style.background='#eef';del.style.color='#333';del.textContent='åˆ é™¤';del.onclick=((idx)=>()=>{messages.splice(idx,1);renderChat()})(i);list.appendChild(item)}}
// æœŸæœ›å¹´è–ªåŠ å‡æŒ‰é’®
document.getElementById('salaryIncrement')?.addEventListener('click',()=>{const input=document.getElementById('minAnnual');const currentValue=parseInt(input.value||'0');input.value=currentValue+1000});
document.getElementById('salaryDecrement')?.addEventListener('click',()=>{const input=document.getElementById('minAnnual');const currentValue=parseInt(input.value||'0');input.value=Math.max(0,currentValue-1000)})
